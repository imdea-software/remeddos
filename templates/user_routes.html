{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% block extrahead %}
   <!--  <link href="{% static 'theme/css/plugins/dataTables/dataTables.bootstrap.css' %}" rel="stylesheet"> -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs5/jq-3.6.0/dt-1.11.3/datatables.min.css"/>
    
    <style>
        body{
            line-height: 0.8rem !important;
        }
        small > a{
            pointer-events: none !important;
            text-decoration: none !important;
            /* color: black !important; */
        }
        .page-item.active .page-link {
        background-color: lightgrey !important;
        border: 1px solid lightgrey;
        }
    .page-link {
        color: black !important;
        background-color: white !important;
        }
    </style>
{% endblock %}
{% block title %}{% trans "User Routes" %}{% endblock %}
{% block contentplaceholder %}
{% csrf_token %}
<div class="container">
    <div class="row rows-cols-4 p-5">
        <div class="col">
            <h3 class="page-heading text-center fw-light">{% trans "Firewall Routes" %} </h3>
        </div>
        <div class="col">
            <div class="panel-heading float-end"> <i class="fa fa-shield"></i><span class="text-end">Firewall Routes</span>
        </div>
        </div>
    </div>
        <div class="panel-body table-responsive">
                    	<table class="table table-hover table-bordered align-middle p-2" id="routes_table">
                        <thead class="bg-dark text-white">
                    <tr>
                        <th>Id</th>
                        <th>{% trans "Name" %}</th>
                        <th>{% trans "Information" %}</th>
                        <th>{% trans "Then Action" %}</th>
                        <th>{% trans "Status" %}</th>
                        <th>{% trans "Belongs to" %}</th>
                        <th>{% trans "Expires" %}</th>
                        <th>{% trans "Answer" %}</th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>

                    <tbody>
                </tbody>
            </table>
            </div>
         </div>
    </div>



{% endblock %}

{% block pagejsbottom %} 
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/jq-3.6.0/dt-1.11.3/datatables.min.js"></script>

<script type="text/javascript">
var filterbtns = '<div class="btn-group d-block gap-2">\
    <button type="button" class="btn btn-outline btn-sm btn-success" name="status_filter" value="ACTIVE" id="show_active">ACTIVE</button>\
    <button type="button" class="btn btn-outline btn-sm btn-info" name="status_filter" value="PENDING" id="show_pending">PENDING</button>\
    <button type="button" class="btn btn-outline btn-sm btn-warning" name="status_filter" value="ERROR" id="show_error">ERROR</button>\
    <button type="button" class="btn btn-outline btn-sm btn-dark" name="status_filter" value="DEACTIVATED" id="show_deactivated">DEACTIVATED</button>\
    </div>';


$.fn.dataTableExt.oApi.fnReloadAjax = function ( oSettings, sNewSource, fnCallback, bStandingRedraw ){
    if ( $.fn.dataTable.versionCheck ) {
        var api = new $.fn.dataTable.Api( oSettings );
        if ( sNewSource ) {
            api.ajax.url( sNewSource ).load( fnCallback, !bStandingRedraw );
        }
        else {
            api.ajax.reload( fnCallback, !bStandingRedraw );
        }
        return;
    }
    if ( sNewSource !== undefined && sNewSource !== null ) {
        oSettings.sAjaxSource = sNewSource;
    }
    if ( oSettings.oFeatures.bServerSide ) {
        this.fnDraw();
        return;
    }

    this.oApi._fnProcessingDisplay( oSettings, true );
    var that = this;
    var iStart = oSettings._iDisplayStart;
    var aData = [];

    this.oApi._fnServerParams( oSettings, aData );
    oSettings.fnServerData.call( oSettings.oInstance, oSettings.sAjaxSource, aData, function(json) {
        that.oApi._fnClearTable( oSettings );
        var aData =  (oSettings.sAjaxDataProp !== "") ?
            that.oApi._fnGetObjectDataFn( oSettings.sAjaxDataProp )( json ) : json;
        for (var i=0 ; i<aData.length ; i++){
            that.oApi._fnAddData( oSettings, aData[i] );
        }
        oSettings.aiDisplay = oSettings.aiDisplayMaster.slice();
        that.fnDraw();
        if ( bStandingRedraw === true ){
            oSettings._iDisplayStart = iStart;
            that.oApi._fnCalculateEnd( oSettings );
            that.fnDraw( false );
        }
        that.oApi._fnProcessingDisplay( oSettings, false );
        if ( typeof fnCallback == 'function' && fnCallback !== null )
        {
            fnCallback( oSettings );
        }
    }, oSettings );
};
var oTable;
var start;
var end;
var oldhtml;
var last_element = false;
var refreshUrl = "{% url 'group-routes-ajax' %}";
$(document).ready( function(){



    oTable = $('#routes_table').dataTable( {
        "bPaginate": true,
        "bFilter": true,
        "bResposive": {
                breakpoints: [
                {name: 'bigdesktop', width: Infinity},
                {name: 'meddesktop', width: 1480},
                {name: 'smalldesktop', width: 1280},
                {name: 'medium', width: 1188},
                {name: 'tabletl', width: 1024},
                {name: 'btwtabllandp', width: 848},
                {name: 'tabletp', width: 768},
                {name: 'mobilel', width: 480},
                {name: 'mobilep', width: 320}
                ]
            },
        "bAutoWidth": true,
        "aLengthMenu" : [
            [5, 15, 20, -1],
            [5, 15, 20, "All"]
        ],
        "sDom": "<'row'<'col col-4'l><'col col-4'<'#filterplaceholder'>><'col col-4'f>><'row'<'col col-6'i><'col col-6'p>>tr<'row'<'col col-6'i><'col col-6'p>>",
        "iDisplayLength": 20,
        "bProcessing": true,
        "sAjaxSource": refreshUrl,
        "bDeferRender": true,
         "fnInitComplete": function(oSettings, json) {
         	oTable.fnSetColumnVis( 0,false );
         	update_size();

          	$('body').on('click', '.revertbutton', function () {
            	var my = $(this);
            	my.parent().html(oldhtml);
            	last_element = false;
            	return false;
            });
        },
        "aoColumns":[
                     {"mData":"id", "bSearchable": false,"bSortable": false, "bvisible":false},
                     {"mData":"details", "sClass" : "alignCenter","bSearchable": true,"bSortable": true,
                     "mRender": function (data, type, full) {
                        if (full.comments !== null) {
                            if (!full.comments.trim()) {
                               return '<small>' + data + '</small>';
                            }
                            return '<a rel="tooltip" href="#" data-bs-toggle="tooltip" data-bs-placement="top" title='+full.comments+'><small>'+data+'</small>'
                        } else {
                            return 'No comments'
                        }
                     }
                     },
                     {"mData":"match", "sClass" : "alignCenter","bSearchable": true,"bSortable": true,
                     "mRender": function (data, type, full) {
                     	return '<small>'+data+'</small>';
                     }
                     },
                     {"mData":"then", "sClass" : "alignCenter","bSearchable": true,"bSortable": true,
                     "mRender": function (data, type, full) {
                     	return '<small>'+data+'</small>';
                     }
                     },
                     {"mData":"status", "sClass" : "alignCenter","bSearchable": true,"bSortable": true,
                     "mRender": function (data, type, full) {
                     	var status = data;
                     	if (status == "EXPIRED" ||status == "ADMININACTIVE" || status == "INACTIVE" || status == "OUTOFSYNC"){
                     		if (status == "EXPIRED" ||status == "ADMININACTIVE" || status == "INACTIVE" ){
                     			return '<span class="badge pill bg-dark">DESACTIVADA</span>';
                     		}
                     		else
                     		{
                     			if (status == "OUTOFSYNC"){
                     				return '<span class="badge pill bg-dark">DESACTIVADA</span>';
                     			}
                     			else{
                     				return status;
                     			}
                     		}
                     	}
                     	else{
                     		if (status == 'ACTIVE'){
                     			return '<span class="badge pill bg-success">'+status+'</span>';
                     		}
                     		else{
                     			if (status == 'PENDING'){
                     				return '<span class="badge pill bg-info">'+status+'</span>';
                     			}
                     			else{
                     				return '<span class="badge pill bg-danger">'+status+'</span>';
                     			}
                     		}
                     	}
                     }
                     },
                     {"mData":"applier", "sClass" : "alignCenter","bSearchable": true,"bSortable": true,
                     "mRender": function (data, type, full) {
                         if(data==null){
                            return '<small>Esta regla no pertenece a nadie hasta que no se haga un commit con el router.</small>';
                         }else{
                            return '<small>'+data+' ('+full.peer+')</small>';
                         }
                     	
                     }
                     },
                     {"mData":"expires", "sClass" : "alignCenter","bSearchable": true,"bSortable": true,
                     "mRender": function (data, type, full) {
                        var parsedate = new Date(data).toLocaleDateString('es-ES',{
                            year:'numeric',
                            month:'long',
                            day:'numeric',
                        });
                        if(parsedate=='Invalid Date'){
                            parsedate = 'No expira'
                        }
                     	return '<small>'+parsedate+'</small>';
                     }},
                     {"mData":"response", "sClass" : "alignCenter","bSearchable": true,"bSortable": true,
                     "mRender": function (data, type, full) {
                     	status = full.status;
                     	toolt = '<a rel="tooltip" href="#" data-bs-toggle="tooltip" data-bs-placement="top"';
   	                     	if (status == "EXPIRED" ||status == "ADMININACTIVE" || status == "INACTIVE" || status == "OUTOFSYNC"){
	                     		if (status == "INACTIVE" ){
	                     			title = "{% trans 'Desactivada por el usuario' %}";
	                     		}
	                     		if (status == "ADMININACTIVE" ){
	                     			title = "{% trans 'Desactivada por el administrador' %}";
	                     		}
	                     		if (status == "EXPIRED" ){
	                     			title = "{% trans 'Desactivada por caducación.' %}";
	                     		}
	                     		if (status == "OUTOFSYNC" ){
	                     			title = "{% trans 'Error por sincronización. Hay diferente configuraciones en el router y base de datos.' %}";
	                     		}
	                     		return toolt+" title=\""+title+"\">"+"<small>{% trans 'Regla caducada' %}</small>"+"</a>";
	                     	}
                     		if (status == "PENDING"){
                     				return "<img src={% static 'dots.gif' %}>";
                     			}
                     		return "<small>"+full.response+"</small>";

                     }
                     },
                     {"mData":"comments", "bSearchable": true,"bSortable": true,
                      "mRender": function (data, type, full) {
                     status = full.status;
                     btn = '';
                     editurl = "{% url 'edit-route' route_slug='routename'  %}".replace('routename', full.name.toString());
                     deleteurl = "{% url 'delete-route' route_slug='routename'  %}".replace('routename', full.name.toString());
                     graphsurl = "{% url 'display-graphs' route_slug='routename'  %}".replace('routename', full.name.toString());
                     if (status == "ACTIVE" ){
                     	btn = '<div class="row"><div class="col col-2 btn-group d-inline"><a href="'+editurl+'" class="btn btn-outline-dark m-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "Editar" %}"><i class="bi-pencil"></i></a>';
                        btn = btn +'<a href="'+deleteurl+'" class="btn btn-outline-dark m-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "Desactivar" %}"><i class="bi-shield-fill-x"></i></a>';
                        btn = btn +'<a href="'+graphsurl+'" class="btn btn-outline-dark m-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "Mostrar gráficos!" %}"><i class="bi-graph-up"></i></a></div></div>';
                    }
                     if (status == 'EXPIRED' || status == 'ADMININACTIVE' || status == 'INACTIVE' ){
                     	btn = '<a href="'+editurl+'" class="btn btn-outline-dark m-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "Reactivar" %}" id="edit_button_{{route.pk}}"><i class="bi-cloud-arrow-up"></i></a>';
                     }
                     if (status == "OUTOFSYNC" ){
                     	btn = '<a href="'+editurl+'" class="btn btn btn-sm btn-outline-danger" id="edit_button_{{route.pk}}">{% trans "Resincronizar" %}</a>';
                     }
                     if (status == "ERROR" ){
                     	btn = '<a href="'+editurl+'" class="btn btn btn-sm btn-outline-warning" id="edit_button_{{route.pk}}">{% trans "Arreglar!" %}</a>';
                     }
                     return btn;
                     },
                    }

         ]
} );
$('#filterplaceholder').html(filterbtns);



    $('body').on('click', 'button[name="status_filter"]', function(){
    	var reg_exp = '';
        var checkboxs = document.getElementsByName('status_filter');
        $(this).button('toggle');
        for (var i = 0, inp; inp = checkboxs[i]; i++) {
            if (inp.type.toLowerCase() == 'button' && $(inp).hasClass('active')) {
                reg_exp = reg_exp + inp.value + '|';
            }
        }
        //passing an empty string will result in no filter
        //thus, it must be set to something that will not exist in the column
        if (reg_exp == '') {
            reg_exp = '|'
        }
        oTable.fnFilter(reg_exp.slice(0, -1), 4, true, false, false);
        console.log(reg_exp.slice(0, -1))
        return false;
    });

  $(window).resize(function() {
    clearTimeout(window.refresh_size);
    window.refresh_size = setTimeout(function() { update_size(); }, 250);
  });

var update_size = function() {
    $(oTable).css({ width: $(oTable).parent().width() });
    pw=$(oTable).parent().width();
    tw=$(oTable).width();
    if (tw>pw){
		oTable.fnSetColumnVis( 7,false );
		oTable.fnSetColumnVis( 5,false );
    }else{
    	oTable.fnSetColumnVis( 7,true );
    	oTable.fnSetColumnVis( 5,true );
    }
    oTable.fnAdjustColumnSizing();
  }
});
</script>
<style type="text/css">


	.dl-horizontal dt {
    width: 70px;
}
.dl-horizontal dd {
    margin-left: 90px;
}

th{
	font-size: 12px;
}
</style>

{% endblock %}