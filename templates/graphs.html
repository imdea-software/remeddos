{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block extrahead %}
<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="{% static 'datepicker/plugins/css/style.css' %}">
<link rel="stylesheet" href="{% static 'datepicker/plugins/css/bootstrap-datetimepicker.min.css' %}">


{% endblock %}
{% block pagejs%}
    <script src="https://www.gstatic.com/charts/loader.js"></script> 
    <script src="{%  static 'datepicker/plugins/js/popper.js' %}"></script>
    <script src="{%  static 'datepicker/plugins/js/moment-with-locales.min.js' %}"></script>
    <script src="{%  static 'datepicker/plugins/js/bootstrap-datetimepicker.min.js' %}"></script>
    <script src="{%  static 'datepicker/plugins/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'datepicker/plugins/js/bootstrap-datetimepicker.min.js'%}"></script>
    <script src="{% static 'datepicker/plugins/js/main.js' %}"></script>
    

{% endblock %}

{% block title %}{% trans "Gráficos" %}{% endblock %}

{% block pagejsbottom %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script>
function sameOrigin(url) {
    // test that a given url is a same-origin URL
    // url could be relative or scheme relative or absolute
    var host = document.location.host; // host + port
    var protocol = document.location.protocol;
    var sr_origin = '//' + host;
    var origin = protocol + sr_origin;
    // Allow absolute or scheme relative URLs to same origin
    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
        // or any other URL that isn't scheme relative or absolute i.e relative.
        !(/^(\/\/|http:|https:).*/.test(url));
};

// usando jQuery
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
};
  function csrfSafeMethod(method) {
        // estos métodos no requieren CSRF
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    };

$("#dateForm").on('submit', function(event){
  var url = "{% url 'ajax-graphs' %}";
  var form = document.querySelector("[name='dateForm']")
  var from = form.elements.from.value;
  var till = form.elements.till.value;
  var routename = form.elements.routename.value;
  var csrftoken = getCookie('csrftoken');
  $.ajaxSetup({
  beforeSend: function(xhr, settings) {
    if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
    xhr.setRequestHeader("X-CSRFToken", csrftoken);
  }
}
  });
  $.ajax({
      url : url,
      data : {
        "till": till,
        "from" : from,
        "routename": routename,
      },
      type : "POST",
      dataType:"json",
      success: function(response){         
          if(response['beats'] && response['time']){
            var beats = response['beats'];
            var time = response['beats_hour'];
            var ctx = $('#curve_chart');
            new Chart(ctx,{
              type:'line',
              data: {
                labels: time,
                datasets:[{
                  label:'Beats',
                  data: beats,
                  borderColor:'#8e5ea2',
                  fill:false
                }]
              },
              options: {
                scales:{
                  yAxes:[{
                    ticks:{
                      beginAtZero:true,
                    }
                  }]
                },
                maintainAspectRatio:true,
                responsive:true,
                legend:{
                  position:'top',
                },
                title:{
                  display: true,
                  text:'Gráfico de {{route.name}}.'
                },
                elements:{
                  line:{
                    tension: 0,
                  }
                }
              }
            });
          }else{
            document.getElementById('curve_chart').innerHTML=response['message'];
          }
        },
        error: function(){
          document.getElementById('curve_chart').innerHTML='Ha habido un error en su petición porfavor contacte con RediMadrid';
            }
          });
        event.preventDefault();
}) 
$('document').ready(function(){
  var form = document.querySelector("[name='dateForm']")
  var routename = form.elements.routename.value;
  var url = "{% url 'ajax-graphs' %}";
  var csrftoken = getCookie('csrftoken');
  $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      }
    }
  })
  $.ajax({
    url: url,
    data : {
        "routename": routename,
      },
      type : "GET",
      dataType:"json",
      success: function(response){         
          if(response['beats'] && response['time']){
            var beats = response['beats'];
            var time = response['beats_hour'];
            var ctx = $('#curve_chart');
            new Chart(ctx,{
              type:'line', 
              data: {
                labels: time,
                datasets:[{
                  label:'Beats',
                  data: beats,
                  borderColor:'rgb(75, 192, 192)',
                  fill:false,
                  tension: 0.1
                }]
              },
              options: {
                scales:{
                  yAxes:[{
                    ticks:{
                      beginAtZero:true,
                    }
                  }]
                },
                maintainAspectRatio:true,
                responsive:true,
                legend:{
                  position:'top',
                },
                title:{
                  display: true,
                  text:'Gráfico de {{route.name}}.'
                },
                elements:{
                  line:{
                    tension: 0,
                  }
                }
              }
            });
          }else{
            document.getElementById('curve_chart').innerHTML=response['message'];
          }
        },
        error: function(){
          document.getElementById('curve_chart').innerHTML='Ha habido un error en su petición porfavor contacte con RediMadrid';
            }
  });

})    
</script>
{% endblock %}

{% block contentplaceholder %}
<div class="container-fluid p-5 m-2">
  <div class="row g-3">
    <div class="col">
      <h3 class="fw-light text-muted text-center p-3 m-2 text-start">Regla de firewall: {{route.name}} </h3>
      </div>
      </div>
      <form class="d-flex flex-row bd-highlight mb-3 datepickers" method="POST" id="dateForm" name="dateForm">
        {% csrf_token %}
        <input type="hidden" value={{route.name}} id="routename" name="routename">
        <div class='p-2 bd-highlight'>
          <div class="form-group">
              <div class='input-group date' id='id_from'>
                  <input type='text' class="form-control js-datetimepicker" id="from" name="from" placeholder="Desde">
              </div>
          </div>
      </div>
      <div class='p-2 bd-highlight'>
        <div class="form-group">
            <div class='input-group date' id='id_till'>
                <input type='text' class="form-control js-datetimepicker" id="till" name="till" placeholder="Hasta">
            </div>
        </div>
    </div>
        <div class="p-2 bd-highlight">
          <button type="submit" class="btn btn-light btn-sm">Aceptar</button>
        </div>
      </form>
    </div>
  
  <canvas id="curve_chart" class="w-100 h-75" name="curve_chart">
</canvas>
  
{% endblock %}
