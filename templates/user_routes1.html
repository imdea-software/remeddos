{% extends "base.html" %}
{% load i18n %}
{% load static %}


{% block extrahead %}
    <!-- <link href="{% static 'theme/css/plugins/dataTables/dataTables.bootstrap.css' %}" rel="stylesheet"> -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <!-- <link rel="stylesheet" href="{% static 'css/dataTable_style.css' %}"> -->
    <link rel="stylesheet" href="{% static 'css/table_style.css' %}">
    <link rel="stylesheet" href="{% static 'css/section_style.css' %}">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs5/jq-3.6.0/dt-1.12.1/datatables.min.css"/>
 


    <!-- <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs5/jq-3.6.0/dt-1.11.3/datatables.min.css"> -->
    <!-- <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/dataTables.jqueryui.min.css"> -->
<style>
body{
    line-height: 0.8rem !important;
    }

small > a{
    pointer-events: none !important;
    text-decoration: none !important;
    
    }
.page-item.active .page-link {
    background-color: lightgrey !important;
    border: 1px solid lightgrey;
    }

.page-link {
    color: black !important;
    background-color: white !important;
    }
</style>

{% endblock %}
{% block title %}{% trans "Mis reglas" %}{% endblock %}
{% block contentplaceholder %}
{% csrf_token %}

<div class="container">
    <div class="row rows-cols-4 p-5">
        <div class="col">
            
            <div class="panel-heading"> <span class="font-monospace">  Reglas de Firewall</span> <i class="fa fa-shield"></i>
        </div>
        </div>
    </div>
        <div class="panel-body table-responsive">
                    	<table class="table table-hover table-responsive compact w-100" id="routes_table">
                        <thead class="">
                    <tr>
                        <th><big>Nombre</big></th>
                        <th><big>Creada</big></th>
                        <th><big>Información</big></th>
                        <th><big>Estado</big></th>
                        <th><big>Pertenece a</big></th>
                        <th><big>Caduca</big></th>
                        <th><big>Respuesta</big></th>
                        <th><big>Otros</big></th>
                    </tr>
                </thead>

                <tbody>
                    {% for route in routes %}
                    <tr>
                        <td class="text-danger"><small>{{route.name}}</small></td>
                        <td><small>{{route.filed|time:"H:i"}}, {{route.filed|date:"d M Y"}}</small></td>
                        <td>
                            {% if route.destination %} <small>{{route.destination}}</small><br> {% endif %}
                             {% if route.source %} <small>{{route.source}}</small><br> {% endif %}  
                            {% if route.protocol %} <small>Protocolo: {% for p in route.protocol.all %} {{p}} {% endfor %}</small><br> {% endif %} 
                            {% if route.port %} <small>Port: {{route.port}}</small><br> {% endif %}
                            {% if route.tcpflag %} <small>Tcpflag: {{route.tcpflag}}</small><br> {% endif %}
                            {% if route.icmptype %} <small>Icmptype: {{route.icmptype}</small><br> {% endif %}
                            {% if route.icmpcode %} <small>Icmpcode: {{route.icmpcode}}</small><br> {% endif %}
                        </td>
                        <td><small>{{route.status}}</small></td>
                        <td><small>{% if route.applier %} {{route.applier}} {% else %}  {% endif %}</small></td>
                        <td><small>{% if route.expires %} {{route.expires}} {% else %} No caduca {% endif %}</small></td>
                        <td><small>{{route.response}}</small></td>
                        <td>
                            <div class="col-2 btn-group d-inline">
                            {% if not route.status == 'ACTIVE' %}
                                {% if not request.COOKIES.token %}
                                    <a id="commitbutton" href="" data-bs-toggle="tootltip" data-bs-placement="bottom" title="Commit Route" class="btn m-1"><i class="bi bi-patch-plus text-warning"></i></a>  
                                {% else %}
                                    <a id="commitbutton" href="" data-bs-toggle="tooltip"  data-bs-placement="bottom" title="Commit Route" class="btn m-1"><i class="bi bi-patch-plus text-warning"></i></a>  
                            {% endif %}
                            {% endif %}
                            {% if not request.COOKIES.token %}
                            <a href="{% url 'edit-route' route.name  %}"  data-bs-toggle="tooltip" data-bs-placement="bottom" title="Edit rule" class="btn m-1"><i class="bi bi-pencil text-info"></i></a>
                            {% else %}
                            <a href="{% url 'edit' route.name  %}"  data-bs-toggle="tooltip" data-bs-placement="bottom" title="Edit rule" class="btn m-1"><i class="bi bi-pencil text-info"></i></a>
                            {% endif %}
                            <a href="{% url 'exterminate' route.name  %}" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete rule" class="btn m-1"><i class="bi bi-trash text-danger"></i></a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            
            </table>
            </div>

            <div class="row p-2 mt-3">
                <div class="col">
                    <div class="card float-right">
                        <h5 class="card-header text-left text-info">
                            Shortcuts
                        </h5>
                        <div class="card-body">
                            <div class="card-text btn-group">
                            {% if not request.COOKIES.token %}
                            <a class="btn btn-sm btn-outline-dark float-left addbutton" id="routebutton" href="#" data-bs-toggle="modal" data-bs-target="#addRouteM"><i class="bi bi-shield-plus text-warning mr-1"></i>Añadir Regla</a>
                            {% else %}
                            <a href="{% url 'add' %}" class="btn btn-outline-dark btn-sm float-left" id="routebutton"><i class="bi bi-shield-plus text-warning mr-1"></i>Añadir Regla</a>
                            {% endif %}
                            <a class="btn btn-outline-dark btn-sm float-left ml-2" href="{% url 'group-routes' %}"> <i class="bi-table text-secondary mr-1"></i>Reglas</a>
                            <a href="{% url 'pending-routes' %}" type="button" class="btn btn-outline-dark btn-sm float-left ml-2"> <i class="bi-clipboard text-danger mr-1"></i>Reglas propuestas</a>
                            <a class="btn btn-outline-dark btn-sm float-left ml-2" href="{% url 'dashboard' %}"> <i class="bi-clipboard text-info mr-1"></i>Dashboard</a>
                        </div>
                        </div>
                        </div>
                    </div>
                </div>


</div>
{% endblock %}

{% block pagejsbottom %} 

<script type="text/javascript" src="https://cdn.datatables.net/v/bs5/jq-3.6.0/dt-1.11.3/datatables.min.js"></script>
<script type="text/javascript">
$('.addbutton').click(function(){
      $.ajax({
              url: "{% url 'add-route' %}",
              type: "GET",
              dataType: "json",
              success: (data) => {
              },
              error: (error) => {
                console.log(error);
              }
            });
     });

var filterbtns = '<div class="btn-group d-block gap-4">\
    <button type="button" class="btn btn-outline-success btn-sm" name="status_filter" value="ACTIVE" id="show_active">ACTIVE</button>\
    <button type="button" class="btn btn-outline-info btn-sm" name="status_filter" value="PENDING" id="show_pending">PENDING</button>\
    <button type="button" class="btn btn-outline-warning btn-sm" name="status_filter" value="ERROR" id="show_error">ERROR</button>\
    <button type="button" class="btn btn-outline-dark btn-sm" name="status_filter" value="DEACTIVATED" id="show_deactivated">DEACTIVATED</button>\
    </div>';


/* $.fn.dataTableExt.oApi.fnReloadAjax = function ( oSettings, sNewSource, fnCallback, bStandingRedraw ){
    if ( $.fn.dataTable.versionCheck ) {
        var api = new $.fn.dataTable.Api( oSettings );
        if ( sNewSource ) {
            api.ajax.url( sNewSource ).load( fnCallback, !bStandingRedraw );
        }
        else {
            api.ajax.reload( fnCallback, !bStandingRedraw );
        }
        return;
    }
    if ( sNewSource !== undefined && sNewSource !== null ) {
        oSettings.sAjaxSource = sNewSource;
    }
    if ( oSettings.oFeatures.bServerSide ) {
        this.fnDraw();
        return;
    }

    this.oApi._fnProcessingDisplay( oSettings, true );
    var that = this;
    var iStart = oSettings._iDisplayStart;
    var aData = [];

    this.oApi._fnServerParams( oSettings, aData );
    oSettings.fnServerData.call( oSettings.oInstance, oSettings.sAjaxSource, aData, function(json) {
        that.oApi._fnClearTable( oSettings );
        var aData =  (oSettings.sAjaxDataProp !== "") ?
            that.oApi._fnGetObjectDataFn( oSettings.sAjaxDataProp )( json ) : json;
        for (var i=0 ; i<aData.length ; i++){
            that.oApi._fnAddData( oSettings, aData[i] );
        }
        oSettings.aiDisplay = oSettings.aiDisplayMaster.slice();
        that.fnDraw();
        if ( bStandingRedraw === true ){
            oSettings._iDisplayStart = iStart;
            that.oApi._fnCalculateEnd( oSettings );
            that.fnDraw( false );
        }
        that.oApi._fnProcessingDisplay( oSettings, false );
        if ( typeof fnCallback == 'function' && fnCallback !== null )
        {
            fnCallback( oSettings );
        }
    }, oSettings );
};
var oTable;
var start;
var end;
var oldhtml;
var last_element = false; */
var refreshUrl = "{% url 'group-routes-ajax' %}"; 


$(document).ready( function(){
    oTable = $('#routes_table').dataTable( {
        "bPaginate": true,
        "bFilter": true,
        "bResposive": {
                breakpoints: [
                {name: 'bigdesktop', width: Infinity},
                {name: 'meddesktop', width: 1480},
                {name: 'smalldesktop', width: 1280},
                {name: 'medium', width: 1188},
                {name: 'tabletl', width: 1024},
                {name: 'btwtabllandp', width: 848},
                {name: 'tabletp', width: 768},
                {name: 'mobilel', width: 480},
                {name: 'mobilep', width: 320}
                ]
            },
        "bAutoWidth": true,
        "aLengthMenu" : [
            [5, 15, 20, -1],
            [5, 15, 20, "All"]
        ],
        "sDom": "<'row'<'col col-4'l><'col col-4'<'#filterplaceholder'>><'col col-4'f>><'row'<'col col-6'i><'col col-6'p>>tr<'row'<'col col-6'i><'col col-6'p>>",
        "iDisplayLength": 20,
        "bProcessing": true,
        "sAjaxSource": refreshUrl,
        "bDeferRender": true,
         "fnInitComplete": function(oSettings, json) {
         	oTable.fnSetColumnVis( 0,false );
         	update_size();

          	$('body').on('click', '.revertbutton', function () {
            	var my = $(this);
            	my.parent().html(oldhtml);
            	last_element = false;
            	return false;
            });
        },
        "aoColumns":[
                     {"mData":"id", "bSearchable": false,"bSortable": false, "bvisible":false},
                     {"mData":"details", "sClass" : "alignCenter","bSearchable": true,"bSortable": true,
                     "mRender": function (data, type, full) {
                        if (full.comments !== null) {
                            if (!full.comments.trim()) {
                               return  '<small>'+data+'</small>';
                            }
                            
                            {% if request.COOKIES.token %}
                            displayurl = "{% url 'edit-route' route_slug='routename'  %}".replace('routename', full.name.toString());
                            {% else %}
                            displayurl = "{% url 'edit' route_slug='routename'  %}".replace('routename', full.name.toString());
                            {% endif %}
                            return '<a rel="tooltip" href="'+displayurl+'" data-bs-toggle="tooltip" data-bs-placement="top" title='+full.comments+'><small>'+data+'</small>'
                        } else {
                            return 'No comments';
                        }
                     }
                     },
         ]
} );
$('#filterplaceholder').html(filterbtns);



    $('body').on('click', 'button[name="status_filter"]', function(){
    	var reg_exp = '';
        var checkboxs = document.getElementsByName('status_filter');
        $(this).button('toggle');
        for (var i = 0, inp; inp = checkboxs[i]; i++) {
            if (inp.type.toLowerCase() == 'button' && $(inp).hasClass('active')) {
                reg_exp = reg_exp + inp.value + '|';
            }
        }
        //passing an empty string will result in no filter
        //thus, it must be set to something that will not exist in the column
        if (reg_exp == '') {
            reg_exp = '|'
        }
        oTable.fnFilter(reg_exp.slice(0, -1), 4, true, false, false);
        console.log(reg_exp.slice(0, -1))
        return false;
    });

  $(window).resize(function() {
    clearTimeout(window.refresh_size);
    window.refresh_size = setTimeout(function() { update_size(); }, 250);
  });

var update_size = function() {
    $(oTable).css({ width: $(oTable).parent().width() });
    pw=$(oTable).parent().width();
    tw=$(oTable).width();
    if (tw>pw){
		oTable.fnSetColumnVis( 7,false );
		oTable.fnSetColumnVis( 5,false );
    }else{
    	oTable.fnSetColumnVis( 7,true );
    	oTable.fnSetColumnVis( 5,true );
    }
    oTable.fnAdjustColumnSizing();
  }
});
</script>
<style type="text/css">


	.dl-horizontal dt {
    width: 70px;
}
.dl-horizontal dd {
    margin-left: 90px;
}

th{
	font-size: 12px;
}
</style>



{% endblock %}